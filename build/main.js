'use strict';const canvas=document.getElementById("screen"),ctx=canvas.getContext("2d");function sleep(a){return new Promise(b=>setTimeout(b,a))}ctx.canvas.width=608,ctx.canvas.height=360;var ac=new AudioContext;let tempo=120,beepNote=new TinyMusic.Note("F3 0.0125"),beepSnd=new TinyMusic.Sequence(ac,120);beepSnd.gain.gain.value=.1,beepSnd.push(beepNote),beepSnd.loop=!1;let walkNote=new TinyMusic.Note("G2 s"),walkSnd=new TinyMusic.Sequence(ac,120);walkSnd.gain.gain.value=.25,walkSnd.push(walkNote),walkSnd.loop=!1;let killNote=new TinyMusic.Note("B2 s"),killSnd=new TinyMusic.Sequence(ac,60);killSnd.waveType="sine",killSnd.gain.gain.value=.12,killSnd.staccato=0,killSnd.bass.gain.value=30,killSnd.treble.gain.value=15,killSnd.push(killNote),killSnd.loop=!1;let goodNote=new TinyMusic.Note("C5 s"),goodSnd=new TinyMusic.Sequence(ac,120);goodSnd.waveType="sine",goodSnd.gain.gain.value=.1,goodSnd.push(goodNote),goodSnd.loop=!1;var level_1=`
#############
#..s........#
#...........#
#.......i...#
#.p.........#
#.......e...#
#############
#############
#############
`,level_2=`
#############
#...####....#
#.#.####e.i.#
#.#....#....#
#.####.#.####
#....#.#....#
####.#.####.#
#p..s#......#
#############
`,level_3=`
#############
######.....e#
######.....i#
######..##.##
#e......#...#
#i.e.#..#i.e#
######..#####
#p.........s#
#############
`,level_4=`
#############
##...#...#.e#
##ei...#...i#
######.######
#s........e.#
###.##.######
###e##p######
######i######
#############
`,level_5=`
#############
##e.i#.....##
###.##.###.##
#s.....###p##
######.######
###e.......##
#####i.e#ie##
#############
#############
`,level_6=`
#############
#############
#############
#############
#############
#############
#############
#############
#############
`,levels=["\n#############\n#..s........#\n#...........#\n#.......i...#\n#.p.........#\n#.......e...#\n#############\n#############\n#############\n",level_2,level_3,level_4,level_5],paths=["","","","",""],secondTry=!1,currentLevelIndex=0;const gridSize=32;var takeInput=!1,timer=13,target="e",goal=0,score=0,animationCounter=0,transition=!1,this_level=levels[currentLevelIndex].split("\n");setupGoal(target),takeInput=!0;var RFD,moveShadowCounter=0,shadowPlayerInterval=290,monoSprite=new Image;monoSprite.src="sprites.png";let enemy={width:32,height:32,color:"red"},hazard={width:32,height:32,color:"orange"},innocent={width:32,height:32,color:"blue"},wall={width:32,height:32,color:"black"},player={width:32,height:32,x:0,y:0,key:"p",color:"green"},shadowPlayer={width:32,height:32,x:0,y:0,key:"p",color:"yellow"};function gotoNextLevel(){!1==secondTry?(secondTry=!0,this_level=levels[currentLevelIndex].split("\n"),target="i",setupGoal(target),moveShadowCounter=0,player.key="s"):(secondTry=!1,player.key="p",currentLevelIndex<levels.length-1?(currentLevelIndex++,this_level=levels[currentLevelIndex].split("\n"),target="e",setupGoal(target)):(clearInterval(main),gameWin(),console.log("end of game")))}function setupGoal(a){let b,c;for(goal=0,b=0;b<this_level.length;b++)for(c=0;c<this_level[1].length;c++)this_level[b][c]==a&&goal++}var oldScore=0;function levelTransition(a){clearTimeout(timerHandler),clearTimeout(shadowPlayerMoving),0==oldScore&&(oldScore=timer,score+=timer),timerRunning=!0,timer=13,ctx.fillStyle="black";let b=(this_level.length-2)*gridSize;animationCounter<b?(animationCounter++,setTimeout(function(){a/=4,levelTransition(a)},a)):(gotoNextLevel(),levelTransitionEnd(100))}function levelTransitionEnd(a){0<animationCounter?(animationCounter--,setTimeout(levelTransitionEnd,a/2)):(oldScore=0,takeInput=!0,transition=!1,timer=13,timerRunning=!1,clearTimeout(shadowPlayerMoving),!0==secondTry&&(shadowPlayerMoving=setTimeout(moveShadowPlayer,shadowPlayerInterval)))}var slowTextHandler,slowTextCounter=0,queueCounter=0;async function drawPixelTextSlow(a,b,c,d,e,f="white"){if(!(queueCounter<a.length))slowTextCounter=0,queueCounter=0;else if(slowTextCounter<a[queueCounter].length){if("narrator"===a[queueCounter])drawPixelText(a[queueCounter][slowTextCounter],b,c,d,!1,"magenta"),beepSnd.play();else if("\n"===a[queueCounter])queueCounter++,slowTextCounter=-1,c+=gridSize,b=-8;else if("stabbing robot 3000"===a[queueCounter])drawPixelText(a[queueCounter][slowTextCounter],b,c,d,!1,"red"),beepSnd.play();else if("b"===a[queueCounter]){ctx.fillStyle="black";let e=a[queueCounter-1].length*(d+10),f=b-(e+d+10);ctx.fillRect(f,c,e,5*d),b=f}else if("c"===a[queueCounter])await sleep(1e3),ctx.fillStyle="black",ctx.fillRect(0,32,608,(this_level.length-2)*gridSize),0===score&&drawPixelText("press space to skip",200,(this_level.length-2)*gridSize,1.5,!1,"orange"),b=-20,c=48;else if("hardware"===a[queueCounter]||"limitations"===a[queueCounter])drawPixelText(a[queueCounter][slowTextCounter],b,c,d,!1,"rgb(249, 152, 240)"),beepSnd.play();else if("Good."===a[queueCounter])drawPixelText(a[queueCounter][slowTextCounter],b,c,d,!1,"rgb(152, 249, 188)"),beepSnd.play();else if("Just remember WASD to move the robot"===a[queueCounter]||"and to stab targets just move into them."==a[queueCounter])drawPixelText(a[queueCounter][slowTextCounter],b,c,d,!1,"rgb(249, 96, 19)"),beepSnd.play();else if("d"===a[queueCounter])await sleep(400);else if("            STABBING NOISES"===a[queueCounter])drawPixelText(a[queueCounter][slowTextCounter],b,c,d,!1,"red");else if("x"===a[queueCounter]){let a,b=this_level.length+2;for(a=0;23>a;a++)ctx.fillStyle="black",ctx.fillRect((b+1)*gridSize-20,160,180,20),drawnScore++,goodSnd.play(),drawPixelText("score "+drawnScore.toString(),(b+1)*gridSize-20,160,3,!0),await sleep(25)}else"v"===a[queueCounter]?(Mousetrap.unbind("space"),main=setInterval(mainLoop,25)):(drawPixelText(a[queueCounter][slowTextCounter],b,c,d,!1,f),beepSnd.play());slowTextCounter++,slowTextHandler=setTimeout(function(){drawPixelTextSlow(a,b+d+10,c,d,e,f)},e)}else slowTextCounter=0,queueCounter++,drawPixelTextSlow(a,b+d+10,c,d,e,f)}function drawPixelText(a,b,c,d,e=!1,f="white"){let g,h=b;for(ctx.fillStyle=f,a=a.toUpperCase(),g=0;g<a.length;g++){let b,f=c,i=h;if(letters[a[g]]!=null){for(b=0;b<letters[a[g]].length;b++){let c;for(e&&(h+=1),c=0;c<letters[a[g]][b].length;c++)1==letters[a[g]][b][c]&&ctx.fillRect(i,f,d,d),i+=d;f+=d,i=h}h+=letters[a[g]].length*d}}}var drawnScore=0;function drawLevel(a){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.lineWidth=1;let b,c;for(b=0;b<a.length;b++)for(c=0;c<a[b].length;c++)switch(a[b][c]){case"#":ctx.fillStyle=wall.color,ctx.drawImage(monoSprite,192,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height);break;case"p":!1==secondTry?(player.x=c,player.y=b,ctx.drawImage(monoSprite,0,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height)):(shadowPlayer.x=c,shadowPlayer.y=b,ctx.drawImage(monoSprite,32,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height));break;case"s":!0==secondTry&&(player.x=c,player.y=b,ctx.drawImage(monoSprite,0,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height));break;case"e":ctx.fillStyle=enemy.color,ctx.drawImage(monoSprite,64,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height);break;case"E":ctx.drawImage(monoSprite,96,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height);break;case"I":ctx.drawImage(monoSprite,160,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height);break;case"i":ctx.fillStyle=innocent.color,ctx.drawImage(monoSprite,128,0,32,32,c*gridSize,b*gridSize,wall.width,wall.height);break;default:}ctx.fillStyle="black";let d=this_level.length+2;if(ctx.fillRect(d*gridSize,32,192,(b-2)*gridSize),drawnScore<score&&(drawnScore++,goodSnd.play()),drawPixelText("score "+drawnScore.toString(),(d+1)*gridSize-20,160,3,!0),drawPixelText("time: "+timer.toString(),(d+1)*gridSize-20,210,3,!0),drawPixelText("target ",(d+1)*gridSize-20,110,3,!0),"i"==target?ctx.drawImage(monoSprite,128,0,32,32,(d+1)*gridSize+100,100,wall.width,wall.height):"e"==target&&ctx.drawImage(monoSprite,64,0,32,32,(d+1)*gridSize+100,100,wall.width,wall.height),!0==transition){ctx.fillStyle="black";let a=this_level[1].length*gridSize;ctx.fillRect(0,32,a,animationCounter)}}function checkCollision(a,b){switch(this_level[b][a]){case"#":return!1;case"E":return!1;case"I":return!1;case"s":case"p":return!0!=secondTry||(RFD=2,gameOver(),!1);case target:return this_level[b]=splice(this_level[b],a,1,target.toUpperCase()),goal--,score+=10,0>=goal&&(transition=!0,takeInput=!1,animationCounter=0,levelTransition(100)),!1;case"i":return"i"!=target&&(this_level[b]=splice(this_level[b],a,1,"I"),RFD=1,gameOver()),!1;case"e":return"e"!=target&&(this_level[b]=splice(this_level[b],a,b,"E"),RFD=1,gameOver()),!1;default:return!0;}}function updatePlayerArray(a,b,c){let d=this_level[c.y+b][c.x+a];this_level[c.y+b]=splice(this_level[c.y+b],c.x+a,1,c.key),this_level[c.y]=splice(this_level[c.y],c.x,1,d),c.y+=b,c.x+=a}var inputDelay=75,stopInput=!1;function resumeInput(){stopInput=!1}function movePlayer(a,b,c){takeInput&&!stopInput&&(checkCollision(player.x+a,player.y+b)&&(updatePlayerArray(a,b,player),!1===secondTry&&(paths[currentLevelIndex]+=c)),stopInput=!0,setTimeout(resumeInput,inputDelay))}Mousetrap.bind("w",function(){movePlayer(0,-1,"n")},"keypress"),Mousetrap.bind("s",function(){movePlayer(0,1,"s")},"keypress"),Mousetrap.bind("a",function(){movePlayer(-1,0,"w")},"keypress"),Mousetrap.bind("d",function(){movePlayer(1,0,"e")},"keypress"),Mousetrap.bind("n",function(){transition=!0,takeInput=!1,animationCounter=0,levelTransition(100)});var shadowPlayerMoving;function moveShadowPlayer(){if(moveShadowCounter<paths[currentLevelIndex].length){switch(paths[currentLevelIndex][moveShadowCounter]){case"n":checkCollision(shadowPlayer.x,shadowPlayer.y-1)&&updatePlayerArray(0,-1,shadowPlayer);break;case"s":checkCollision(shadowPlayer.x,shadowPlayer.y+1)&&updatePlayerArray(0,1,shadowPlayer);break;case"e":checkCollision(shadowPlayer.x+1,shadowPlayer.y)&&updatePlayerArray(1,0,shadowPlayer);break;case"w":checkCollision(shadowPlayer.x-1,shadowPlayer.y)&&updatePlayerArray(-1,0,shadowPlayer);}moveShadowCounter++}"e"==this_level[shadowPlayer.y-1][shadowPlayer.x]?this_level[shadowPlayer.y-1]=splice(this_level[shadowPlayer.y-1],shadowPlayer.x,1,"E"):"e"==this_level[shadowPlayer.y+1][shadowPlayer.x]?this_level[shadowPlayer.y+1]=splice(this_level[shadowPlayer.y+1],shadowPlayer.x,1,"E"):"e"==this_level[shadowPlayer.y][shadowPlayer.x+1]?this_level[shadowPlayer.y]=splice(this_level[shadowPlayer.y],shadowPlayer.x+1,1,"E"):"e"==this_level[shadowPlayer.y][shadowPlayer.x-1]&&(this_level[shadowPlayer.y]=splice(this_level[shadowPlayer.y],shadowPlayer.x-1,1,"E")),shadowPlayerMoving=setTimeout(moveShadowPlayer,shadowPlayerInterval)}var gameOverCounter=0;function gameOver(){takeInput=!1,killSnd.play(),clearTimeout(shadowPlayerMoving),clearInterval(main),gameOverCounter=0,drawGameOver(.025)}var gameoverHandler;function drawGameOver(a){ctx.fillStyle="red";let b=(this_level[1].length+6)*gridSize;ctx.fillRect(0,32,b,gameOverCounter);let c=(this_level.length-2)*gridSize;gameOverCounter<c?(gameOverCounter++,gameoverHandler=setTimeout(drawGameOver,a)):(drawPixelText("G A M E O V E R",b/4,c/2,4),0===RFD?drawPixelText("TIME RAN OUT",b/4,c/1.5,2):1===RFD?drawPixelText("YOU KILLED THE INCORRECT TARGET",b/4,c/1.5,2):2===RFD?drawPixelText("YOU GOT KILLED BY YOUR PAST SELF",b/4,c/1.5,2):void 0,drawPixelText("PRESS R TO RESTART",b/4,c/1.2,2),Mousetrap.bind("r",function(){Mousetrap.unbind("r"),clearTimeout(gameoverHandler),timer=13,clearTimeout(shadowPlayerMoving),moveShadowCounter=0,!1==secondTry?target="e":(target="i",shadowPlayerMoving=setTimeout(moveShadowPlayer,200)),score=0,drawnScore=0,animationCounter=0,transition=!1,this_level=levels[currentLevelIndex].split("\n"),goal=0,setupGoal(target),takeInput=!0,main=setInterval(mainLoop,25)}))}var timerHandler,timerRunning=!1;function updateTimer(){0<timer?timer--:(RFD=0,gameOver()),timerRunning=!1}function mainLoop(){!1==timerRunning&&(timerRunning=!0,timerHandler=setTimeout(updateTimer,1e3)),drawLevel(this_level)}let titleContents=["Hello dear player.  It is I the","narrator","!","d","\n","And you are the","stabbing robot 3000","\n","your task is to stab","m y political opponents","b","very bad people.","\n","d","This would be a simple task but due to","hardware","\n","limitations","you will have to kill half the targets","\n","within two 13 second chunks. ","\n","The side bar will inform you of your target","c","If you stab the wrong target you will recieve","\n","a gameover. Also when you kill the second half","\n","of targets you'll have to avoid yourself killing","\n","the first half of targets.","\n","Confusing?","d","d","d","Good.","\n","Just remember WASD to move the robot","\n","and to stab targets just move into them.","d","d","d","d","d","v"];var main;function titleScreen(){ctx.fillStyle="black",ctx.fillRect(0,32,608,(this_level.length-2)*gridSize),drawPixelTextSlow(titleContents,5,48,2,65),drawPixelText("press space to skip",200,(this_level.length-2)*gridSize,1.5,!1,"orange"),Mousetrap.bind("space",function(){clearTimeout(slowTextHandler),Mousetrap.unbind("space"),slowTextCounter=0,queueCounter=0,main=setInterval(mainLoop,25)})}function splashScreen(){ctx.fillStyle="black",ctx.fillRect(0,32,608,(this_level.length-2)*gridSize),drawPixelText("BACKSTABBERS",60,48,7,!0,"red"),drawPixelText("BACKSTABBERS",63,50,7,!0,"lime"),drawPixelText("A GAME ABOUT STABBING",80,90,3,!0,"lime"),drawPixelText("PRESS ENTER TO START GAME",90,180,2,!1,"red"),drawPixelText("PRESS ENTER TO START GAME",91,180,2,!1,"lime"),drawPixelText("PRESS S TO BUY SKINS",90,240,2,!1,"red"),drawPixelText("PRESS S TO BUY SKINS",91,240,2,!1,"lime"),Mousetrap.bind("enter",function(){Mousetrap.unbind("enter"),titleScreen()})}function gameWin(){let a=["GOOD JOB!","\n","You have taken down all the targets.","\n","You even netted a total of "+score+" points!","\n","HOWEVER, this is not the end of our journey,","\n","stabbing robot 3000","there will inevitably be","\n","more targets to be stabbed during my","\n","illegal seizure of power               ","b","LEGITIMATE CAMPAIGN.","c","so uhh.. great  job hero!","d","\n","err..","d","power off?","d","d","d","\n","wait what are you doing with that knife?","\n","d","d","TURN OFF  ROBOT!   STOP!","\n","d","d","I DEMAND YOU STOP ROBOT","d","\n","ROBOT TURN OF F","\n","            STABBING NOISES","d","d","d","d","d","d","d","x","c","d","d","d","d","d","d","d","d","d","\n","you win.","d","d","d","d","d","d","d","d","d","\n","c","Here's some trivia:","\n","Backstabbers was remorsefully developed by","\n","Milan Donhowe","for the 2019 13kb JS GameJam","\n","Libraries used include:","\n","Voca.js","Mousetrap","PixelFont","And TinyMusic."];ctx.fillStyle="black",ctx.fillRect(0,32,608,(this_level.length-2)*gridSize),drawPixelTextSlow(a,5,54,2,50)}function endGame(a){if(ctx.fillStyle="black",ctx.fillRect(0,32,608,(this_level.length-2)*gridSize),a)console.log("z pressed");else{drawPixelTextSlow(["c","SHUTTING DOWN PROCESSES","d","d","d","COMPLETE."],0,32,2,50)}drawPixelTextSlow(["c","Wait,","stabbing robot 3000","what are yo-","\n","d","STABBING SOUNDS","d","d","d","d","d","scorejoke"],0,32,2,50)}splashScreen();